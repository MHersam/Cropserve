<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SchadenErfassen.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">de.uni_stuttgart.informatik.sopra.sopraapp</a> &gt; <span class="el_source">SchadenErfassen.java</span></div><h1>SchadenErfassen.java</h1><pre class="source lang-java linenums">package de.uni_stuttgart.informatik.sopra.sopraapp;

import android.Manifest;
import android.app.Dialog;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.Color;
import android.location.Location;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.support.annotation.Nullable;
import android.support.v4.app.ActivityCompat;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentTransaction;
import android.support.v4.content.FileProvider;
import android.util.DisplayMetrics;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.WindowManager;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import com.google.android.gms.maps.CameraUpdateFactory;
import com.google.android.gms.maps.GoogleMap;
import com.google.android.gms.maps.model.LatLng;
import com.google.android.gms.maps.model.Marker;
import com.google.android.gms.maps.model.MarkerOptions;
import com.google.android.gms.maps.model.Polygon;
import com.google.android.gms.maps.model.PolygonOptions;

import java.io.File;
import java.io.IOException;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import static de.uni_stuttgart.informatik.sopra.sopraapp.MainActivity.drawPolygons;
import static de.uni_stuttgart.informatik.sopra.sopraapp.MainActivity.mMap;
import static de.uni_stuttgart.informatik.sopra.sopraapp.MainActivity.polygons;
import static de.uni_stuttgart.informatik.sopra.sopraapp.MainActivity.userId;
import static de.uni_stuttgart.informatik.sopra.sopraapp.SchadensfallFragment.schadenID;

/**
 * Class that controls the view for registering a new damage case
 *
 * @author Patrick Koss
 * @author Sarah Gutierrez Mu√±oz
 * @author Michael Hersam
 */
public class SchadenErfassen extends Fragment {

    //attributes
    static final int REQUEST_IMAGE_CAPTURE = 1;
<span class="fc" id="L69">    final int CAMERA_REQUEST = 100;</span>
    String mCurrentPhotoPath;
<span class="fc" id="L71">    public static ArrayList&lt;Marker&gt; marker = new ArrayList&lt;Marker&gt;();</span>
    double lat;
    double lng;
<span class="fc" id="L74">    String schadensart = &quot;&quot;;</span>
<span class="fc" id="L75">    String gutachter = &quot;&quot;;</span>
    TextView land;
    TextView bland;
    TextView landkreis;
    TextView stadt;
<span class="fc" id="L80">    public Region reg = new Region(&quot;S&quot;, &quot;S&quot;, &quot;S&quot;, &quot;S&quot;, 1);</span>
    String[] bilder;
<span class="fc" id="L82">    Polygon polygon = polygon = mMap.addPolygon(new PolygonOptions()</span>
<span class="fc" id="L83">            .add(new LatLng(0, 0))</span>
<span class="fc" id="L84">            .fillColor(Color.parseColor(&quot;#660000ff&quot;))</span>
<span class="fc" id="L85">            .strokeColor(Color.parseColor(&quot;#660000ff&quot;))</span>
<span class="fc" id="L86">            .strokeWidth(5));</span>


    /**
     * constructor
     */
<span class="fc" id="L92">    public SchadenErfassen() {</span>
        // Required empty public constructor
<span class="fc" id="L94">    }</span>


    @Override
    public void onCreate(Bundle savedInstanceState) {
<span class="fc" id="L99">        super.onCreate(savedInstanceState);</span>
<span class="fc" id="L100">    }</span>

    /**
     * Inflates the view/layout for this fragment
     *
     * @param inflater
     * @param container
     * @param savedInstanceState
     * @return
     */
    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        // Inflate the layout for this fragment
<span class="fc" id="L114">        return inflater.inflate(R.layout.fragment_schaden_erfassen, container, false);</span>
    }

    /**
     * @param view
     * @param savedInstanceState prior (if existing) state
     */
    @Override
    public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
<span class="fc" id="L123">        super.onViewCreated(view, savedInstanceState);</span>
<span class="fc" id="L124">        drawPolygons(getActivity().getApplicationContext());</span>
<span class="fc" id="L125">        marker.removeAll(marker);</span>
<span class="fc" id="L126">        schadenID = -1;</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">        for(int i=0;i&lt;polygons.size();i++){</span>
<span class="fc" id="L128">            polygons.get(i).setClickable(false);</span>
        }

        //get screen with and height
<span class="fc" id="L132">        DisplayMetrics displayMetrics = new DisplayMetrics();</span>
<span class="fc" id="L133">        WindowManager wm = (WindowManager) getActivity().getSystemService(Context.WINDOW_SERVICE);</span>
<span class="fc" id="L134">        wm.getDefaultDisplay().getMetrics(displayMetrics);</span>
<span class="fc" id="L135">        int screenWidth = displayMetrics.widthPixels;</span>
<span class="fc" id="L136">        int screenHeight = displayMetrics.heightPixels;</span>

        //Buttons initialization to set markers(edges from the field), getLocation and save the selected field
<span class="fc" id="L139">        Button save = getActivity().findViewById(R.id.saveDmgInfo);</span>
<span class="fc" id="L140">        Button setMarker = getActivity().findViewById(R.id.setDmgMarker);</span>
<span class="fc" id="L141">        Button gps = getActivity().findViewById(R.id.gpsDmg);</span>
<span class="fc" id="L142">        Button addInfo = getActivity().findViewById(R.id.addDmgInfo);</span>

<span class="fc" id="L144">        save.setWidth(100);</span>
<span class="fc" id="L145">        save.setHeight(40);</span>
<span class="fc" id="L146">        save.setX(screenWidth - screenWidth / 4);</span>
<span class="fc" id="L147">        save.setY(screenHeight - screenHeight / 4);</span>
<span class="fc" id="L148">        save.setText(R.string.save_btn);</span>

<span class="fc" id="L150">        setMarker.setWidth(50);</span>
<span class="fc" id="L151">        setMarker.setHeight(70);</span>
<span class="fc" id="L152">        setMarker.setX(0);</span>
<span class="fc" id="L153">        setMarker.setY(screenHeight - screenHeight / 4);</span>
<span class="fc" id="L154">        setMarker.setText(R.string.pos_btn);</span>

<span class="fc" id="L156">        gps.setWidth(50);</span>
<span class="fc" id="L157">        gps.setHeight(40);</span>
<span class="fc" id="L158">        gps.setX(screenWidth / 2);</span>
<span class="fc" id="L159">        gps.setY(screenHeight - screenHeight / 4);</span>
<span class="fc" id="L160">        gps.setText(R.string.gps_btn);</span>

        //user is getting ask if he want to allow the location permission
<span class="fc" id="L163">        ActivityCompat.requestPermissions(getActivity(), new String[]{Manifest.permission.ACCESS_FINE_LOCATION}, 123);</span>


<span class="fc" id="L166">        gps.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="fc" id="L169">                GPSTracker g = new GPSTracker(getActivity().getApplicationContext());</span>
<span class="fc" id="L170">                Location l = g.getLocation();</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">                if (l != null) {</span>
<span class="fc" id="L172">                    lat = l.getLatitude();</span>
<span class="fc" id="L173">                    lng = l.getLongitude();</span>
                }
<span class="fc" id="L175">                mMap.moveCamera(CameraUpdateFactory.newLatLngZoom(new LatLng(lat, lng), 15));</span>
<span class="fc" id="L176">            }</span>
        });


<span class="fc" id="L180">        setMarker.setOnClickListener(new View.OnClickListener() {</span>
            public void onClick(View v) {
<span class="fc" id="L182">                marker.add(mMap.addMarker(new MarkerOptions()</span>
<span class="fc" id="L183">                        .position(new LatLng(mMap.getCameraPosition().target.latitude, mMap.getCameraPosition().target.longitude))</span>
<span class="fc" id="L184">                        .title(String.valueOf(marker.size() + 1))</span>
<span class="fc" id="L185">                        .draggable(true)</span>
                ));
<span class="fc" id="L187">                polygon.remove();</span>
<span class="fc" id="L188">                ArrayList&lt;LatLng&gt; triangle = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">                for (int i = 0; i &lt; marker.size(); i++) {</span>
<span class="fc" id="L190">                    triangle.add(marker.get(i).getPosition());</span>
                }
<span class="fc" id="L192">                triangle.add(triangle.get(0));</span>
<span class="fc" id="L193">                polygon = mMap.addPolygon(new PolygonOptions()</span>
<span class="fc" id="L194">                        .addAll(triangle)</span>
<span class="fc" id="L195">                        .fillColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="fc" id="L196">                        .strokeColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="fc" id="L197">                        .strokeWidth(5));</span>
<span class="fc" id="L198">                triangle.removeAll(triangle);</span>
<span class="fc" id="L199">            }</span>
        });


        /*button for saving the added, new information of a dmg case*/
<span class="fc" id="L204">        save.setOnClickListener(new View.OnClickListener() {</span>
            public void onClick(View v) {
                //check if damage case area is actually an area
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">                if (marker.size() &gt;= 3) {</span>
                    //check if the additional information was added
                    //TODO check it correctly
<span class="pc bpc" id="L210" title="4 of 8 branches missed.">                    if (reg.getLand().equals(&quot;S&quot;) || reg.getStadt().equals(&quot;S&quot;) || reg.getBundesland().equals(&quot;S&quot;) || reg.getLandkreis().equals(&quot;S&quot;)) {</span>
<span class="nc" id="L211">                        Toast.makeText(getContext(), getString(R.string.info_missing2), Toast.LENGTH_LONG).show();</span>
                    } else {
                        //TODO put in values from camera
<span class="fc" id="L214">                        bilder = new String[1];</span>
<span class="fc" id="L215">                        bilder[0] = &quot;bilder&quot;;</span>


                        //get area
                        double flaeche;
<span class="fc" id="L220">                        flaeche =  berechnePolygonFlaeche(marker);</span>


                        //create coordinates for the field, first and last latitude/longitude has to be the same
<span class="fc" id="L224">                        LatLng coordinates[] = new LatLng[marker.size() + 1];</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">                        for (int i = 0; i &lt; marker.size(); i++) {</span>
<span class="fc" id="L226">                            coordinates[i] = marker.get(i).getPosition();</span>
                        }
<span class="fc" id="L228">                        coordinates[marker.size()] = marker.get(0).getPosition();</span>
<span class="fc" id="L229">                        DatenbankDaten db = new DatenbankDaten(getActivity());</span>
<span class="fc" id="L230">                        db.open();</span>
                        //get all fields
<span class="fc" id="L232">                        Feld[] felder = db.getFeld();</span>
<span class="fc" id="L233">                        ArrayList&lt;Feld&gt; userFelder = new ArrayList&lt;Feld&gt;();</span>
                        //search for the fields the user has registered
<span class="fc bfc" id="L235" title="All 2 branches covered.">                        for (int i = 0; i &lt; felder.length; i++) {</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">                            if(userId&gt;=0){</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">                                if (userId == felder[i].getVertrag().getPerson().getId())</span>
<span class="fc" id="L238">                                    userFelder.add(felder[i]);</span>
                            }
                            else{
<span class="nc" id="L241">                                userFelder.add(felder[i]);</span>
                            }
                        }
<span class="fc" id="L244">                        Feld feld = null;</span>
                        //we need to check if the coordinates of the damage case are in one of the registered fields
                        //in this variable is saved how often coordinates of the damage case are in the field
<span class="fc" id="L247">                        int coordinateCounter = 0;</span>
                        //to avoid that one coordinate is in one field and one coordinate is in another one, we need to save the counter after each loop of the second loop
<span class="fc" id="L249">                        List&lt;Integer&gt; merkerList = new ArrayList&lt;Integer&gt;();</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">                        for (int i = 0; i &lt; userFelder.size(); i++) {</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">                            for (int j = 0; j &lt; coordinates.length - 1; j++) {</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">                                if (punktInPolygon(userFelder.get(i).getKoordinaten(), coordinates[j]) == 1) {</span>
<span class="fc" id="L253">                                    coordinateCounter++;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                                } else if (punktInPolygon(userFelder.get(i).getKoordinaten(), coordinates[j]) == 0) {</span>
<span class="nc" id="L255">                                    coordinateCounter++;</span>
                                } else break;
                            }
<span class="fc" id="L258">                            merkerList.add(coordinateCounter);</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                            if (coordinateCounter == coordinates.length - 1) feld = userFelder.get(i);</span>
<span class="fc" id="L260">                            coordinateCounter = 0;</span>
                        }

                        //now the list has to be sorted to get the largest element on the last position
<span class="fc" id="L264">                        Collections.sort(merkerList);</span>
                        //if the last element in the sortedList merkerList is the number of total coordinates of the damage case then save it
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">                        if (merkerList.get(userFelder.size() - 1) == coordinates.length - 1) {</span>
                            //get the matching region from the database
<span class="fc bfc" id="L268" title="All 2 branches covered.">                            for (int i = 0; i &lt; db.getRegion().length; i++) {</span>
<span class="pc bpc" id="L269" title="2 of 4 branches missed.">                                if (db.getRegion()[i].getStadt().equals(reg.getStadt()) &amp;&amp; db.getRegion()[i].getBundesland().equals(reg.getBundesland())) {</span>
<span class="fc" id="L270">                                    Schadensfall[] schadensfall = db.getSchadensfall();</span>
<span class="fc" id="L271">                                    db.addSchadensfall(new Schadensfall(schadensart, feld, coordinates, getString(R.string.dmg_status), db.getRegion()[i], Calendar.getInstance().getTime().toString(), bilder, schadenID, flaeche, db.getGutachterById(Integer.parseInt(gutachter.split(&quot;:&quot;)[0]))));</span>
                                }
                            }
                            //reset the static variable to avoid anomalies
                            //schadenID = -1;
<span class="fc" id="L276">                            drawPolygons(getActivity().getApplicationContext());</span>
<span class="fc" id="L277">                            marker.removeAll(marker);</span>

                            //go back to the previous fragment
<span class="fc" id="L280">                            FragmentManager fm = getActivity().getSupportFragmentManager();</span>
<span class="fc" id="L281">                            SchadensfallFragment schadensfallFragment = new SchadensfallFragment();</span>
<span class="fc" id="L282">                            FragmentTransaction ft = fm.beginTransaction();</span>
<span class="fc" id="L283">                            ft.replace(R.id.flContent, schadensfallFragment).addToBackStack(&quot;tag&quot;).commit();</span>
<span class="fc" id="L284">                        } else {</span>
<span class="nc" id="L285">                            Toast.makeText(getContext(), getString(R.string.coordinate_missing), Toast.LENGTH_SHORT).show();</span>
                        }
<span class="fc" id="L287">                    }</span>
                } else
                    //user warning
<span class="nc" id="L290">                    Toast.makeText(getContext(), getString(R.string.marker_missing), Toast.LENGTH_SHORT).show();</span>
<span class="fc" id="L291">            }</span>
        });

        //if you hold the marker you can drag and drop it to new position
<span class="fc" id="L295">        mMap.setOnMarkerDragListener(new GoogleMap.OnMarkerDragListener() {</span>
            @Override
            public void onMarkerDragStart(Marker marker) {

<span class="fc" id="L299">            }</span>

            @Override
            public void onMarkerDrag(Marker markers) {
<span class="nc" id="L303">                markers.setPosition(markers.getPosition());</span>
<span class="nc" id="L304">                polygon.remove();</span>
<span class="nc" id="L305">                ArrayList&lt;LatLng&gt; triangle = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                for (int i = 0; i &lt; marker.size(); i++) {</span>
<span class="nc" id="L307">                    triangle.add(marker.get(i).getPosition());</span>
                }
<span class="nc" id="L309">                triangle.add(triangle.get(0));</span>
<span class="nc" id="L310">                polygon = mMap.addPolygon(new PolygonOptions()</span>
<span class="nc" id="L311">                        .addAll(triangle)</span>
<span class="nc" id="L312">                        .fillColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="nc" id="L313">                        .strokeColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="nc" id="L314">                        .strokeWidth(5));</span>
<span class="nc" id="L315">                triangle.removeAll(triangle);</span>
<span class="nc" id="L316">            }</span>

            @Override
            public void onMarkerDragEnd(Marker marker) {

<span class="fc" id="L321">            }</span>
        });

<span class="fc" id="L324">        mMap.setOnMarkerClickListener(new GoogleMap.OnMarkerClickListener() {</span>

            @Override
            public boolean onMarkerClick(Marker mark) {
<span class="fc" id="L328">                marker.remove(mark);</span>
<span class="fc" id="L329">                mark.remove();</span>
<span class="fc" id="L330">                polygon.remove();</span>
<span class="fc" id="L331">                ArrayList&lt;LatLng&gt; triangle = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">                for (int i = 0; i &lt; marker.size(); i++) {</span>
<span class="fc" id="L333">                    triangle.add(marker.get(i).getPosition());</span>
                }
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">                if(marker.size()!=0){</span>
<span class="fc" id="L336">                    triangle.add(triangle.get(0));</span>
<span class="fc" id="L337">                    polygon = mMap.addPolygon(new PolygonOptions()</span>
<span class="fc" id="L338">                            .addAll(triangle)</span>
<span class="fc" id="L339">                            .fillColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="fc" id="L340">                            .strokeColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="fc" id="L341">                            .strokeWidth(5));</span>
<span class="fc" id="L342">                    triangle.removeAll(triangle);</span>
                }
<span class="fc" id="L344">                return true;</span>
            }
        });

<span class="fc" id="L348">        mMap.setOnMapClickListener(new GoogleMap.OnMapClickListener() {</span>
            @Override
            public void onMapClick(LatLng latLng) {
<span class="fc" id="L351">                marker.add(mMap.addMarker(new MarkerOptions()</span>
<span class="fc" id="L352">                        .position(latLng)</span>
<span class="fc" id="L353">                        .title(String.valueOf(marker.size() + 1))</span>
<span class="fc" id="L354">                        .draggable(true)</span>
                ));
<span class="fc" id="L356">                polygon.remove();</span>
<span class="fc" id="L357">                ArrayList&lt;LatLng&gt; triangle = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">                for (int i = 0; i &lt; marker.size(); i++) {</span>
<span class="fc" id="L359">                    triangle.add(marker.get(i).getPosition());</span>
                }
<span class="fc" id="L361">                triangle.add(triangle.get(0));</span>
<span class="fc" id="L362">                polygon = mMap.addPolygon(new PolygonOptions()</span>
<span class="fc" id="L363">                        .addAll(triangle)</span>
<span class="fc" id="L364">                        .fillColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="fc" id="L365">                        .strokeColor(Color.parseColor(&quot;#66ff0000&quot;))</span>
<span class="fc" id="L366">                        .strokeWidth(5));</span>
<span class="fc" id="L367">                triangle.removeAll(triangle);</span>
<span class="fc" id="L368">            }</span>
        });


        //add compulsory info to the reported dmg case
<span class="fc" id="L373">        addInfo.setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
                // custom dialog
<span class="fc" id="L377">                final Dialog dialog = new Dialog(getContext());</span>
<span class="fc" id="L378">                dialog.setContentView(R.layout.dialogsffragment);</span>
<span class="fc" id="L379">                dialog.setTitle(&quot;Title...&quot;);</span>

                //dialogue window headline
<span class="fc" id="L382">                TextView dg_header = getActivity().findViewById(R.id.dg_descr2);</span>

                /*initialisation*/

                //init spinner #1 Schadensart
<span class="fc" id="L387">                final Spinner spinnerSchArt = dialog.findViewById(R.id.spinnerSchArt);</span>
                // Create an ArrayAdapter using the string array from res/values/strings and a default spinner layout
<span class="fc" id="L389">                ArrayAdapter&lt;CharSequence&gt; adapter = ArrayAdapter.createFromResource(getContext(), R.array.schadens_arten, android.R.layout.simple_spinner_item);</span>
                // Specify the layout to use when the list of choices appears
<span class="fc" id="L391">                adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);</span>
                // Apply the adapter to the spinner
<span class="fc" id="L393">                spinnerSchArt.setAdapter(adapter);</span>
<span class="fc" id="L394">                spinnerSchArt.setSelection(1);</span>

                //init spinner #2 Gutachter
<span class="fc" id="L397">                final Spinner spinnerSchGutachter = dialog.findViewById(R.id.spinnerSchGutachter);</span>
<span class="fc" id="L398">                ArrayAdapter&lt;String&gt; adapter2 = new ArrayAdapter&lt;String&gt;(getContext(), android.R.layout.simple_spinner_item, getGutachterNames());</span>
<span class="fc" id="L399">                adapter2.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);</span>
<span class="fc" id="L400">                spinnerSchGutachter.setAdapter(adapter2);</span>


                /*button init */
<span class="fc" id="L404">                Button cancelBtn = dialog.findViewById(R.id.btn_abbrechen);</span>
                //simply cancel input of information upon click
<span class="fc" id="L406">                cancelBtn.setOnClickListener(new View.OnClickListener() {</span>
                    @Override
                    public void onClick(View v) {
<span class="fc" id="L409">                        dialog.dismiss();</span>
<span class="fc" id="L410">                    }</span>
                });

                /*Button photoBtn = dialog.findViewById(R.id.sphotoBtn);
                photoBtn.setOnClickListener(new View.OnClickListener() {
                    @Override
                    public void onClick(View view) {
                        //call for camera action
                        dispatchTakePictureIntent();
                    }
                });*/


<span class="fc" id="L423">                Button okBtn = dialog.findViewById(R.id.button_ok);</span>
                //same function as OK btn in FeldErfassen - here is an extra SAVE btn for saving
<span class="fc" id="L425">                okBtn.setOnClickListener(new View.OnClickListener() {</span>
                    @Override
                    public void onClick(View view) {
<span class="fc" id="L428">                        land = dialog.findViewById(R.id.land2_text);</span>
<span class="fc" id="L429">                        bland = dialog.findViewById(R.id.bland2_text);</span>
<span class="fc" id="L430">                        landkreis = dialog.findViewById(R.id.lkreis2_text);</span>
<span class="fc" id="L431">                        stadt = dialog.findViewById(R.id.stadt2_text);</span>
<span class="fc" id="L432">                        schadensart = spinnerSchArt.getSelectedItem().toString();</span>
<span class="fc" id="L433">                        gutachter = spinnerSchGutachter.getSelectedItem().toString();</span>

<span class="fc" id="L435">                        DatenbankDaten db = new DatenbankDaten(getActivity().getApplicationContext());</span>
<span class="fc" id="L436">                        db.open();</span>
                        //check if the information is filled in
<span class="pc bpc" id="L438" title="7 of 8 branches missed.">                        if (!land.getText().toString().matches(&quot;&quot;) || !bland.getText().toString().matches(&quot;&quot;) || !landkreis.getText().toString().matches(&quot;&quot;) || !stadt.getText().toString().matches(&quot;&quot;)) {</span>
<span class="fc" id="L439">                            reg = new Region(landkreis.getText().toString(), land.getText().toString(), bland.getText().toString(), stadt.getText().toString(), 1);</span>
<span class="fc" id="L440">                            Region[] regions = db.getRegion();</span>
                            //check if there is already an existing region in the database
<span class="fc" id="L442">                            int counter = 0;</span>
<span class="fc bfc" id="L443" title="All 2 branches covered.">                            for (int i = 0; i &lt; regions.length; i++) {</span>
<span class="pc bpc" id="L444" title="2 of 4 branches missed.">                                if (regions[i].getStadt().equals(stadt.getText().toString()) &amp;&amp; regions[i].getBundesland().equals(bland.getText().toString()))</span>
<span class="fc" id="L445">                                    counter++;</span>
                            }
                            //if not add new region
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">                            if (counter == 0)</span>
<span class="nc" id="L449">                                db.addRegion(reg);</span>
                            //close dialog
<span class="fc" id="L451">                            dialog.dismiss();</span>
<span class="fc" id="L452">                        } else</span>
<span class="nc" id="L453">                            Toast.makeText(getContext(), getString(R.string.info_missing3), Toast.LENGTH_SHORT).show();</span>
<span class="fc" id="L454">                    }</span>
                });

                //open dialogue on Button click
<span class="fc" id="L458">                dialog.show();</span>
<span class="fc" id="L459">            }</span>
        });
<span class="fc" id="L461">    }</span>

    /*-------------------POINT POLYGON-------------------*/

    /**
     * method checks if a point is in the Polygon
     *
     * @param coordinates coordinates of the Polygon
     * @param testPunkt   point that should be tested
     * @return returns t=1 if the point is in the polygon, returns t=0 if the point is on the polygon and returns t=-1 if the point is not in or on the polygon
     */
    public static int punktInPolygon(LatLng[] coordinates, LatLng testPunkt) {
<span class="fc" id="L473">        int t = -1;</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">        for (int i = 0; i &lt; coordinates.length - 1; i++) {</span>
<span class="fc" id="L475">            t = t * KreuzProdTest(testPunkt, coordinates[i], coordinates[i + 1]);</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">            if (t == 0) break;</span>
        }
<span class="fc" id="L478">        return t;</span>
    }

    /**
     * helping method to test if the point is in the polygon
     *
     * @param a koordinate
     * @param b koordinate
     * @param c koordinate
     * @return int Kreuzprodukt
     */
    public static int KreuzProdTest(LatLng a, LatLng b, LatLng c) {
<span class="pc bpc" id="L490" title="1 of 4 branches missed.">        if (a.longitude == b.longitude &amp;&amp; b.longitude == c.longitude) {</span>
<span class="pc bpc" id="L491" title="6 of 8 branches missed.">            if ((b.latitude &lt;= a.latitude &amp;&amp; a.latitude &lt;= c.latitude) || (c.latitude &lt;= a.latitude &amp;&amp; a.latitude &lt;= b.latitude)) {</span>
<span class="fc" id="L492">                return 0;</span>
            } else {
<span class="nc" id="L494">                return 1;</span>
            }
        }
<span class="pc bpc" id="L497" title="1 of 4 branches missed.">        if (a.latitude == b.latitude &amp;&amp; a.longitude == b.longitude) {</span>
<span class="nc" id="L498">            return 0;</span>
        }
<span class="fc bfc" id="L500" title="All 2 branches covered.">        if (b.longitude &gt; c.longitude) {</span>
<span class="fc" id="L501">            LatLng temp = c;</span>
<span class="fc" id="L502">            c = b;</span>
<span class="fc" id="L503">            b = temp;</span>
        }
<span class="fc bfc" id="L505" title="All 4 branches covered.">        if (a.longitude &lt;= b.longitude || a.longitude &gt; c.longitude) {</span>
<span class="fc" id="L506">            return 1;</span>
        }
<span class="fc" id="L508">        double delta = ((b.latitude - a.latitude) * (c.longitude - a.longitude)) - ((b.longitude - a.longitude) * (c.latitude - a.latitude));</span>
<span class="fc bfc" id="L509" title="All 2 branches covered.">        if (delta &gt; 0) {</span>
<span class="fc" id="L510">            return -1;</span>
<span class="fc bfc" id="L511" title="All 2 branches covered.">        } else if (delta &lt; 0) {</span>
<span class="fc" id="L512">            return 1;</span>
<span class="fc" id="L513">        } else return 0;</span>
    }


    /**
     * fetches all existing gutachter from data base
     *
     * @return ArrayList with all Gutachter names
     */
    public ArrayList&lt;String&gt; getGutachterNames() {
        //list that will hold the Gutachter names
<span class="fc" id="L524">        ArrayList&lt;String&gt; gaNames = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L526">        DatenbankDaten getGaName = new DatenbankDaten(getActivity().getApplicationContext());</span>
<span class="fc" id="L527">        getGaName.open();</span>

        //iterate through list of Gutachter from db
<span class="fc bfc" id="L530" title="All 2 branches covered.">        for (Gutachter g : getGaName.getGutachter()) {</span>
<span class="fc" id="L531">            String name = g.getId() + &quot;: &quot; + g.getVorname() + &quot; &quot; + g.getNachname();</span>
<span class="fc" id="L532">            gaNames.add(name);</span>
        }
<span class="fc" id="L534">        getGaName.close();</span>

<span class="fc" id="L536">        return gaNames;</span>

    }


    /*---------------------AREA CALCULATION-------------------*/
    /*
     * distance of two lng/lat points in kilometers
     * Haversine formula
     * @param lat1 latitude of 1st marker
     * @param lng1 longitude of 1st marker
     * @param lat2 latitude of 2nd marker
     * @param lng2 longitude of 2nd marker
     * @return double distance between two markers
     */
    public static double distFrom(double lat1, double lng1, double lat2, double lng2) {
<span class="nc" id="L552">        double earthRadius = 6371.0; // kilometers (or 3958.75 miles)</span>
<span class="nc" id="L553">        double dLat = Math.toRadians(lat2-lat1);</span>
<span class="nc" id="L554">        double dLng = Math.toRadians(lng2-lng1);</span>
<span class="nc" id="L555">        double sindLat = Math.sin(dLat / 2);</span>
<span class="nc" id="L556">        double sindLng = Math.sin(dLng / 2);</span>
<span class="nc" id="L557">        double a = Math.pow(sindLat, 2) + Math.pow(sindLng, 2)</span>
<span class="nc" id="L558">                * Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2));</span>
<span class="nc" id="L559">        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));</span>
<span class="nc" id="L560">        double dist = earthRadius * c;</span>

<span class="nc" id="L562">        return dist;</span>
    }


    /**
     *
     * @param marker
     * @return
     */
    public double berechnePolygonFlaeche(ArrayList&lt;Marker&gt; marker) {
<span class="fc" id="L572">        final int EARTH_RADIUS = 6371; //in km</span>
<span class="fc" id="L573">        HashMap&lt;Marker, List&lt;Double&gt;&gt; coords = new HashMap&lt;&gt;();</span>


<span class="fc bfc" id="L576" title="All 2 branches covered.">        for(Marker m : marker) {</span>
<span class="fc" id="L577">            ArrayList&lt;Double&gt; xys = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L579">            double latitude = Double.valueOf(m.getPosition().latitude);</span>
<span class="fc" id="L580">            double longitude = Double.valueOf(m.getPosition().longitude);</span>

            //convert to radian
<span class="fc" id="L583">            latitude = latitude * Math.PI/180;</span>
<span class="fc" id="L584">            longitude = longitude * Math.PI/180;</span>

            //convert with smth similar to equirectangular projection
<span class="fc" id="L587">            double x = EARTH_RADIUS * Math.sin(latitude) * Math.cos(longitude);</span>
<span class="fc" id="L588">            double y = EARTH_RADIUS * Math.sin(latitude) * Math.sin(longitude);</span>
<span class="fc" id="L589">            double z = EARTH_RADIUS * Math.cos(latitude);</span>

            //double x = EARTH_RADIUS * Math.cos(latitude) * Math.cos(longitude);
            //double y = EARTH_RADIUS * Math.cos(latitude) * Math.sin(longitude);
            //double z = EARTH_RADIUS * Math.sin(latitude);

            //Equirectangular projection (d0 and a0 are 0)
            //double x = longitude; //x= (longitude-a0)*cos(d0)
            //double y = latitude; //y =(latitude-d0)

<span class="fc" id="L599">            xys.add(x);</span>
<span class="fc" id="L600">            xys.add(y);</span>

<span class="fc" id="L602">            coords.put(m, xys);</span>
<span class="fc" id="L603">        }</span>

<span class="fc" id="L605">        double flaeche = 0;</span>

<span class="pc bpc" id="L607" title="1 of 2 branches missed.">        if(marker.size() == 3 ) {</span>
            //side from first to second marker
<span class="nc" id="L609">            double c = distFrom(marker.get(0).getPosition().latitude, marker.get(0).getPosition().longitude, marker.get(1).getPosition().latitude, marker.get(1).getPosition().latitude);</span>
            //side from 2nd to third marker
<span class="nc" id="L611">            double a = distFrom(marker.get(1).getPosition().latitude, marker.get(1).getPosition().longitude, marker.get(2).getPosition().latitude, marker.get(2).getPosition().latitude);</span>
            //side from 3rd to 1st marker
<span class="nc" id="L613">            double b = distFrom(marker.get(2).getPosition().latitude, marker.get(2).getPosition().longitude, marker.get(0).getPosition().latitude, marker.get(0).getPosition().latitude);</span>
            //angle between c ( 1st side) and a (2nd side)
<span class="nc" id="L615">            double cosB = (Math.pow(a,2) + Math.pow(c,2 ) - Math.pow(b, 2)) / (2 * a * c);</span>
<span class="nc" id="L616">            double beta  = Math.acos(cosB);</span>

<span class="nc" id="L618">            flaeche = round(((c * a * Math.sin(beta)) / 2), 4);</span>

<span class="nc" id="L620">        } else {</span>

        /*Gauss' area formula*/
<span class="fc bfc" id="L623" title="All 2 branches covered.">            for (int a = 0; a &lt; marker.size() - 1; a++) {</span>
<span class="fc" id="L624">                double x1 = coords.get(marker.get(a)).get(0);</span>
<span class="fc" id="L625">                double y1 = coords.get(marker.get(a)).get(1);</span>

<span class="fc" id="L627">                double x2 = coords.get(marker.get(a + 1)).get(0);</span>
<span class="fc" id="L628">                double y2 = coords.get(marker.get(a + 1)).get(1);</span>


<span class="fc" id="L631">                flaeche = flaeche + ((x1 * y2) - (y1 * x2));</span>
            }

            //last term contains first marker x,y again; multiply with last marker
<span class="fc" id="L635">            flaeche += ((coords.get(marker.get(marker.size() - 1)).get(0) * coords.get(marker.get(0)).get(1))</span>
<span class="fc" id="L636">                    - ((coords.get(marker.get(marker.size() - 1)).get(1)) * coords.get(marker.get(0)).get(0)));</span>


<span class="fc" id="L639">            flaeche = round(Math.abs((flaeche/ 2.0)* EARTH_RADIUS), 4);</span>
        }

        //in km^2; * 100 to achieve hectare
<span class="fc" id="L643">        double area = flaeche*100;</span>

<span class="fc" id="L645">        return area;</span>
    }


    /**
     * rounds a double (down) to a specified decimal place
     *
     * @param value the given double
     * @param places number of decimals
     * @return the rounded double
     */
    public static double round(double value, int places) {
<span class="pc bpc" id="L657" title="1 of 2 branches missed.">        if (places &lt; 0) throw new IllegalArgumentException();</span>

<span class="fc" id="L659">        BigDecimal bd = new BigDecimal(value);</span>
<span class="fc" id="L660">        bd = bd.setScale(places, RoundingMode.HALF_DOWN);</span>
<span class="fc" id="L661">        return bd.doubleValue();</span>
    }


    /* -------------------PHOTO METHODS----------------------*/

    /**
     * sends an intent to start camera application
     * starts the activity
     * handles the event (photo) on a positive activity result
     */
    /*private void dispatchTakePictureIntent() {
        //Standard Intent action that can be sent to have the camera application capture an image and return it
        Intent takePictureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
        // Ensure that there's a camera activity to handle the intent
        if (takePictureIntent.resolveActivity(getContext().getPackageManager()) != null) {
            // Create the File where the photo should go
            File photoFile = null;
            try {
                photoFile = createImageFile();
            } catch (IOException ex) {
                // Error occurred while creating the File
                Log.e(&quot;error&quot;, &quot;Error while creating photo file&quot;);
            }
            // Continue only if the File was successfully created
            if (photoFile != null) {
                // return a content URI for the given file
                Uri photoURI = FileProvider.getUriForFile(getContext(),&quot;de.uni_stuttgart.informatik.sopra.sopraapp.fileprovider&quot;,
                        photoFile);
                //EXTRA_OUTPUT: used to indicate a content resolver Uri to be used to store the requested image
                takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, photoURI);

                startActivityForResult(takePictureIntent, REQUEST_IMAGE_CAPTURE);
                onActivityResult(CAMERA_REQUEST, getActivity().RESULT_OK, takePictureIntent);
            }

        }
    }


    /**
     * Retrieves the encoded the photo in the return Intent
     * delivered as a parameter
     *
     * @param requestCode
     * @param resultCode
     * @param data
     */
    /*@Override
    public  void onActivityResult(int requestCode, int resultCode, Intent data) {
        if (requestCode == CAMERA_REQUEST &amp;&amp; resultCode == getActivity().RESULT_OK) {
            //the encoded photo that was taken as a thumbnail
            Bitmap photo = (Bitmap) data.getExtras().get(&quot;data&quot;);
            //imageView.setImageBitmap(photo); // this would display the photo in the app as it is
            Log.i(&quot;CameraDemo&quot;, &quot;Pic saved&quot;);
            //TODO save the picture in the given file path =&gt; @xml/file_paths, it is ../files/Pictures
            //TODO save picture to db, connected with the correct schadensfall
            String photoPath = mCurrentPhotoPath;
            DatenbankDaten db = new DatenbankDaten(getActivity().getApplicationContext());
            db.open();
            /*  here would be the saving, we have the absolute image path with mCurrentPhotoPath
            * which is saved/created after taking the photo
            * but i'm not sure if we even create the file
            * */



            /*db.close();
        }
    }


    /**
     * Creates the image file for the taken photo in
     * specified directory
     *
     * Sets the absolute file path for that photo
     *
     * @return (image (&quot;.jpg&quot;)) file representing the photo that was taken
     * @throws IOException
     */
    /*private File createImageFile() throws IOException {
        // Create an image file name
        String timeStamp = new SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;).format(new Date());
        String imageFileName = &quot;JPEG_&quot; + timeStamp + &quot;_&quot;;

        /* returns the path to files folder inside Android/data/data/your_package/ on your SD card
         * Environment.DIRECTORY_PICTURES: directory in which to place pictures that are available to the user */
        /*File storageDir = getActivity().getExternalFilesDir(Environment.DIRECTORY_PICTURES);

        //new empty file in the specified directory, with prefix and suffix strings to generate its name
        /*File image = File.createTempFile(
                imageFileName,  //pefix
                &quot;.jpg&quot;,         //suffix
                storageDir      //directory
        );

        // Save a file: path for use with ACTION_VIEW intents
        mCurrentPhotoPath = image.getAbsolutePath();
        return image;
    }*/

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span>Generated by the Android Gradle plugin 2.3.3</div></body></html>